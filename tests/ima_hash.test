#!/bin/bash
#
# evmctl ima_hash tests
#
# Copyright (C) 2019 Vitaly Chikunov <vt@altlinux.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

cd $(dirname $0)
PATH=../src:$PATH
source ./functions.sh
_require evmctl openssl

# Check with constant
check_const() {
  local alg=$1 pref=$2 hash=$3 file=$4

  FOR=$alg DEL=$file \
    _evmctl_run ima_hash --hashalgo $alg --xattr-user $file || return
  FOR=$alg \
    _test_ima_xattr $file $pref$hash || return
  rm $file
  return $OK
}

check() {
  local alg=$1 pref=$2 hash=$3
  local file=$alg-hash.txt

  rm -f $file
  touch $file
  cmd="openssl dgst ${ENGINE:+-engine $ENGINE} -$alg $file"
  echo - $cmd
  hash=$(set -o pipefail; eval "$cmd" 2>/dev/null | cut -d' ' -f2)
  if [ $? -ne 0 ] && _is_positive_test; then
    echo $CYAN"$alg test is skipped"$NORM
    rm $file
    return $SKIP
  fi
  check_const $alg $pref "$hash" $file
}

# check args: algo prefix hex-hash
pos check md4    0x01
pos check md5    0x01
pos check sha1   0x01
neg check SHA1   0x01 # uppercase
neg check sha512-224 0x01 # valid for pkcs1
neg check sha512-256 0x01 # valid for pkcs1
neg check unknown 0x01 # nonexistent
pos check sha224 0x0407
pos check sha256 0x0404
pos check sha384 0x0405
pos check sha512 0x0406
pos check rmd160 0x0403
neg check sm3     0x01
neg check sm3-256 0x01
_enable_gost_engine
pos check md_gost12_256 0x0412
pos check streebog256   0x0412
pos check md_gost12_512 0x0413
pos check streebog512   0x0413

_report_exit
